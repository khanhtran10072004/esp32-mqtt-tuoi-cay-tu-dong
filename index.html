<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>Smart Garden Pro (MQTT)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
<style>
Â /* CSS tÃ¹y chá»‰nh */
Â body{font-family:sans-serif;text-align:center;background:#f4f7f6;padding:10px;color:#333;}
Â .card{background:#fff;max-width:440px;margin:20px auto;padding:20px;border-radius:15px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
Â .row{display:flex;justify-content:space-between;margin:12px 0;border-bottom:1px dashed #eee;padding-bottom:5px;align-items:center;}
Â button{padding:12px;border:none;border-radius:8px;color:#fff;font-weight:bold;margin:5px;cursor:pointer;flex:1;transition: transform 0.1s;}
Â button:active { transform: scale(0.98); }
Â .b-on{background:#27ae60;} .b-off{background:#c0392b;} 
Â .b-auto{background:#2980b9;} .b-man{background:#f39c12;color:#333;}
Â .b-dis{background:#e0e0e0!important;color:#999!important;pointer-events:none;}
Â #error-box { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(220,53,69,0.95); color:white; z-index:99; flex-direction:column; justify-content:center; align-items:center;}
Â input[type=number] { width:60px; padding:5px; text-align:center; border:1px solid #ddd; border-radius:5px; }
Â input[type=time] { width:90px; padding:5px; text-align:center; border:1px solid #ddd; border-radius:5px; }
Â input[type=range] { width: 100%; margin-right: 10px; }
Â .save-btn{background:#7f8c8d;font-size:12px;padding:5px 10px;flex:0;}
Â #mqtt-status { font-size: 12px; color: gray; }
</style>
</head>
<body>
Â <div id="error-box"><div style="font-size:20px;font-weight:bold;margin-bottom:20px;">âš ï¸ Cáº¢NH BÃO!<br>BÆ¡m 3 láº§n khÃ´ng áº©m!</div><button onclick="mqttSendCmd('MAN')" style="background:white;color:red;width:200px;">Táº®T BÃO Äá»˜NG</button></div>
<div class='card'>
Â <div class="flex justify-between items-center mb-4">
Â  Â <h3 class="text-xl font-bold">VÆ°á»n ThÃ´ng Minh MQTT</h3>
Â  Â <a href="history.html" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm">
Â  Â  Â <i class="fa-solid fa-chart-line"></i> Lá»‹ch Sá»­ TÆ°á»›i
Â  Â </a>
Â </div>
Â 
Â <div id="mqtt-status">Äang káº¿t ná»‘i MQTT...</div>
Â <div id="auth-info" class="text-xs text-gray-500 mb-2">Auth...</div>
Â 
Â <div class='row'><span>ğŸ•’ Giá»:</span><b id='time'>--</b></div>
Â <div class='row'><span>ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™:</span><b id='temp'>-- Â°C</b></div>
Â <div class='row'><span>ğŸ’§ Äá»™ áº©m Ä‘áº¥t:</span><b id='soil'>--</b></div>
Â <div class='row'><span>âš™ï¸ Cháº¿ Ä‘á»™:</span><b id='mode'>--</b></div>
Â <div class='row'><span>ğŸ”Œ MÃ¡y BÆ¡m:</span><b id='pump'>--</b></div>

Â <div id='admin' style='margin-top:20px;'>
Â  Â <div style='display:flex;'><button id='btnOn' class='b-on' onclick="mqttSendCmd('ON')">Báº¬T</button><button id='btnOff' class='b-off' onclick="mqttSendCmd('OFF')">Táº®T</button></div>
Â  Â <div style='display:flex;'><button id='btnAu' class='b-auto' onclick="mqttSendCmd('AUTO')">AUTO</button><button id='btnMan' class='b-man' onclick="mqttSendCmd('MAN')">THá»¦ CÃ”NG</button></div>
Â  Â 
Â  Â <hr style='border:0;border-top:1px solid #eee;margin:15px 0;'>
Â  Â <div class='row' style="display:block;text-align:left;">
Â  Â  Â <div style="display:flex;justify-content:space-between;"><span>ğŸš€ Tá»‘c Ä‘á»™ bÆ¡m:</span><b id="lblSpd">255</b></div>
Â  Â  Â <div style="display:flex;align-items:center;margin-top:5px;">
Â  Â  Â  Â  <input type="range" id="rngSpd" min="70" max="255" oninput="updSpd(this.value)" onchange="sndSpd(this.value)">
Â  Â  Â </div>
Â  Â </div>

Â  Â <hr style='border:0;border-top:1px solid #eee;margin:15px 0;'>
Â  Â <div class='row'><span>Äáº¥t KhÃ´ Báº­t (>):</span><div><input type='number' id='inS'><button class='save-btn' onclick="setVal('S', 'inS', 1, 1023)">LÆ°u</button></div></div>
Â  Â <div class='row'><span>Nhiá»‡t Max (<):</span><div><input type='number' id='inT'><button class='save-btn' onclick="setVal('T', 'inT', 0, 100)">LÆ°u</button></div></div>
Â  Â <div class='row' style="display:block;text-align:left"><div>Giá» TÆ°á»›i:</div><div style="display:flex;justify-content:space-between;margin-top:5px;"><input type='time' step='1' id='inTS'> - <input type='time' step='1' id='inTE'><button class='save-btn' onclick="setTime()">LÆ°u</button></div></div>

Â  Â <hr style='border:0;border-top:1px dashed #eee;margin:15px 0;'>
Â  Â <div class='row'><span>â±ï¸ BÆ¡m (s):</span><div><input type='number' id='inPon'><button class='save-btn' onclick="setVal('PON', 'inPon', 1, 300)">LÆ°u</button></div></div>
Â  Â <div class='row'><span>â³ Nghá»‰ (s):</span><div><input type='number' id='inSoak'><button class='save-btn' onclick="setVal('SOAK', 'inSoak', 1, 600)">LÆ°u</button></div></div>
Â </div>
</div>

<script type="module">
Â import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

Â // === CÃ€I Äáº¶T FIREBASE VÃ€ MQTT ===
Â const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
Â const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

Â let db;
Â let auth;
Â let userId = null;
Â let isAuthReady = false;

Â // Biáº¿n tráº¡ng thÃ¡i Ä‘á»ƒ ghi log tÆ°á»›i
Â let lastPumpState = 0;
Â let pumpStartTimestamp = 0;
Â let lastStatusData = {};

Â // === KHá»I Táº O FIREBASE ===
Â setLogLevel('debug');
Â const app = initializeApp(firebaseConfig);
Â db = getFirestore(app);
Â auth = getAuth(app);

Â // XÃ¡c thá»±c vÃ  láº¥y userId
Â onAuthStateChanged(auth, async (user) => {
Â  Â if (user) {
Â  Â  Â userId = user.uid;
Â  Â  Â document.getElementById('auth-info').innerText = `User ID: ${userId}`;
Â  Â  Â isAuthReady = true;
Â  Â } else {
Â  Â  Â userId = 'anonymous_' + crypto.randomUUID();
Â  Â  Â // ÄÄƒng nháº­p ban Ä‘áº§u
Â  Â  Â if (initialAuthToken) {
Â  Â  Â  Â await signInWithCustomToken(auth, initialAuthToken);
Â  Â  Â } else {
Â  Â  Â  Â await signInAnonymously(auth);
Â  Â  Â }
Â  Â }
Â });

Â // === THIáº¾T Láº¬P MQTT ===
Â const MQTT_SERVER = "broker.hivemq.com";
Â const MQTT_PORT = 8884;
Â const MQTT_CLIENT_ID = "Web_SmartGarden_" + parseInt(Math.random() * 100000); 
Â const TOPIC_STATUS = "sg/esp32/garden1/status";
Â const TOPIC_COMMAND = "sg/esp32/garden1/cmd";
Â const TOPIC_SETTINGS = "sg/esp32/garden1/set";
Â 
Â let mqttClient; 
Â 
Â function mqttConnect() {
Â  Â mqttClient = new Paho.MQTT.Client(MQTT_SERVER, MQTT_PORT, MQTT_CLIENT_ID); 
Â  Â mqttClient.onConnectionLost = onConnectionLost;
Â  Â mqttClient.onMessageArrived = onMessageArrived;
Â 
Â  Â let options = {
Â  Â  Â timeout: 3,
Â  Â  Â onSuccess: onConnect,
Â  Â  Â onFailure: onFailure,
Â  Â  Â useSSL: true
Â  Â };
Â  Â 
Â  Â document.getElementById('mqtt-status').innerText = "Äang káº¿t ná»‘i...";
Â  Â mqttClient.connect(options);
Â }
Â 
Â function onConnect() {
Â  Â document.getElementById('mqtt-status').innerText = "âœ… ÄÃ£ káº¿t ná»‘i MQTT";
Â  Â mqttClient.subscribe(TOPIC_STATUS);
Â  Â console.log("MQTT Connected & Subscribed to " + TOPIC_STATUS);
Â }
Â 
Â function onFailure(responseObject) {
Â  Â document.getElementById('mqtt-status').innerText = "âŒ Lá»—i káº¿t ná»‘i MQTT. Thá»­ láº¡i sau 5s.";
Â  Â console.log("MQTT Failed: " + responseObject.errorMessage);
Â  Â setTimeout(mqttConnect, 5000);
Â }
Â 
Â function onConnectionLost(responseObject) {
Â  Â if (responseObject.errorCode !== 0) {
Â  Â  Â  console.log("MQTT Connection Lost: " + responseObject.errorMessage);
Â  Â  Â  mqttConnect();
Â  Â }
Â }
Â 
Â function onMessageArrived(message) {
Â  Â if (message.destinationName === TOPIC_STATUS) {
Â  Â  Â  const data = JSON.parse(message.payloadString);
Â  Â  Â  logWateringEvent(data); // Kiá»ƒm tra vÃ  ghi log
Â  Â  Â  updateUI(data); Â  Â  Â  Â  Â // Cáº­p nháº­t giao diá»‡n
Â  Â  Â  lastStatusData = data; 
Â  Â }
Â }

Â window.mqttSendCmd = function(cmd) {
Â  Â if (mqttClient && mqttClient.isConnected()) {
Â  Â  Â  const message = new Paho.MQTT.Message(cmd);
Â  Â  Â  message.destinationName = TOPIC_COMMAND;
Â  Â  Â  mqttClient.send(message);
Â  Â } else {
Â  Â  Â  alert("ChÆ°a káº¿t ná»‘i MQTT! Vui lÃ²ng chá».");
Â  Â }
Â }
Â 
Â window.mqttSendSetting = function(key, value) {
Â  Â if (mqttClient && mqttClient.isConnected()) {
Â  Â  Â  const message = new Paho.MQTT.Message(key + "=" + value);
Â  Â  Â  message.destinationName = TOPIC_SETTINGS;
Â  Â  Â  mqttClient.send(message);
Â  Â } else {
Â  Â  Â  alert("ChÆ°a káº¿t ná»‘i MQTT! Vui lÃ²ng chá».");
Â  Â }
Â }

Â // === LOGIC GHI LOG VÃ€O FIREBASE ===
Â async function logWateringEvent(d) {
Â  Â // Náº¿u mÃ¡y bÆ¡m vá»«a Táº®T vÃ  trÆ°á»›c Ä‘Ã³ Ä‘ang Báº¬T
Â  Â if (d.p === 0 && lastPumpState === 1 && pumpStartTimestamp !== 0 && isAuthReady) {
Â  Â  Â  const durationMs = Date.now() - pumpStartTimestamp;
Â  Â  Â  const durationSeconds = Math.round(durationMs / 1000);

Â  Â  Â  if (durationSeconds > 0) {
Â  Â  Â  Â  const historyData = {
Â  Â  Â  Â  Â  timestamp: new Date().toISOString(),
Â  Â  Â  Â  Â  userId: userId,
Â  Â  Â  Â  Â  durationSeconds: durationSeconds,
Â  Â  Â  Â  Â  triggerMode: lastStatusData.m === 1 ? 'AUTO' : 'MANUAL',
Â  Â  Â  Â  Â  soilReadingBefore: lastStatusData.s || null, // Láº¥y giÃ¡ trá»‹ Soil trÆ°á»›c khi táº¯t
Â  Â  Â  Â  Â  soilReadingAfter: d.s, Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Láº¥y giÃ¡ trá»‹ Soil ngay sau khi táº¯t
Â  Â  Â  Â  Â  temperature: d.t,
Â  Â  Â  Â  Â  pumpSpeed: lastStatusData.sspd,
Â  Â  Â  Â  Â  appId: appId,
Â  Â  Â  Â  };
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const historyRef = collection(db, `artifacts/${appId}/public/data/watering_history`);
Â  Â  Â  Â  Â  await addDoc(historyRef, historyData);
Â  Â  Â  Â  Â  console.log("Lá»‹ch sá»­ tÆ°á»›i Ä‘Ã£ Ä‘Æ°á»£c ghi vÃ o Firestore.");
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error("Lá»—i khi ghi lá»‹ch sá»­ vÃ o Firestore: ", e);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  pumpStartTimestamp = 0; // Reset timestamp sau khi ghi log
Â  Â } 
Â  Â // Náº¿u mÃ¡y bÆ¡m vá»«a Báº¬T
Â  Â else if (d.p === 1 && lastPumpState === 0) {
Â  Â  Â  pumpStartTimestamp = Date.now();
Â  Â  Â  console.log("MÃ¡y bÆ¡m Báº¬T, ghi nháº­n thá»i gian báº¯t Ä‘áº§u.");
Â  Â }

Â  Â lastPumpState = d.p; // Cáº­p nháº­t tráº¡ng thÃ¡i bÆ¡m
Â }

Â // === HÃ€M Xá»¬ LÃ GIAO DIá»†N ===
Â function updateUI(d){
Â  Â document.getElementById('time').innerText=d.time;
Â  Â document.getElementById('temp').innerText=d.t + ' Â°C';
Â  Â document.getElementById('soil').innerText=d.s;
Â  Â document.getElementById('mode').innerText=d.m?'AUTO':'THá»¦ CÃ”NG';
Â  Â 
Â  Â let p=document.getElementById('pump');
Â  Â p.innerText=d.p?'CHáº Y ('+d.sspd+')':'Táº®T'; 
Â  Â p.style.color=d.p?'#27ae60':'#c0392b';
Â  Â document.getElementById('error-box').style.display = (d.err == 1) ? 'flex' : 'none';

Â  Â // Cáº­p nháº­t giÃ¡ trá»‹ cÃ i Ä‘áº·t náº¿u ngÆ°á»i dÃ¹ng khÃ´ng gÃµ
Â  Â if(document.activeElement.tagName!='INPUT' && document.activeElement.tagName!='BUTTON'){
Â  Â  Â  document.getElementById('inS').value=d.ss; document.getElementById('inT').value=d.st;
Â  Â  Â  document.getElementById('inTS').value=d.sts.substring(0,5); 
Â  Â  Â  document.getElementById('inTE').value=d.ste.substring(0,5); 
Â  Â  Â  document.getElementById('inPon').value=d.spon; document.getElementById('inSoak').value=d.ssoak;
Â  Â  Â  document.getElementById('rngSpd').value=d.sspd; document.getElementById('lblSpd').innerText=d.sspd;
Â  Â }
Â  Â 
Â  Â let bOn=document.getElementById('btnOn'), bOff=document.getElementById('btnOff');
Â  Â let bAu=document.getElementById('btnAu'), bMan=document.getElementById('btnMan');
Â  Â if(d.m==1){ 
Â  Â  Â bOn.classList.add('b-dis'); 
Â  Â  Â bOff.classList.add('b-dis'); 
Â  Â  Â bAu.style.border="2px solid #333"; 
Â  Â  Â bMan.style.border="none"; 
Â  Â  Â bMan.style.opacity="0.5"; 
Â  Â  Â bAu.style.opacity="1";
Â  Â } else { 
Â  Â  Â bOn.classList.remove('b-dis'); bOff.classList.remove('b-dis'); 
Â  Â  Â bMan.style.border="2px solid #333"; bAu.style.border="none"; bAu.style.opacity="0.5"; bMan.style.opacity="1";
Â  Â }
Â };
Â 
Â // Cáº­p nháº­t sá»‘ hiá»ƒn thá»‹ bÃªn cáº¡nh thanh trÆ°á»£t khi kÃ©o
Â window.updSpd = function(v){ document.getElementById('lblSpd').innerText = v; }
Â // Gá»­i giÃ¡ trá»‹ tá»‘c Ä‘á»™ khi tháº£ thanh trÆ°á»£t
Â window.sndSpd = function(v){ mqttSendSetting('SPD', v); }

Â window.setVal = function(key, id, min, max){
Â  Â let val = parseInt(document.getElementById(id).value);
Â  Â if(isNaN(val) || val < min || val > max){ alert("GiÃ¡ trá»‹ ko há»£p lá»‡!"); return;}
Â  Â mqttSendSetting(key, val); 
Â  Â alert('ÄÃ£ lÆ°u!');
Â }
Â window.setTime = function(){
Â  Â let t1 = document.getElementById('inTS').value; 
Â  Â let t2 = document.getElementById('inTE').value;
Â  Â if(t1.length==5) t1+=":00"; 
Â  Â if(t2.length==5) t2+=":00";
Â  Â mqttSendSetting('TS', t1); 
Â  Â mqttSendSetting('TE', t2); 
Â  Â alert('ÄÃ£ lÆ°u giá»!');
Â }
Â 
Â // Báº¯t Ä‘áº§u káº¿t ná»‘i khi trang táº£i xong
Â window.onload = mqttConnect;
</script>
</body>
</html>
