<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Smart Garden Pro (MQTT)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f4f7f6;
      padding: 10px;
      color: #333;
    }
    .card {
      background: #fff;
      max-width: 440px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .row {
      display: flex;
      justify-content: space-between;
      margin: 12px 0;
      border-bottom: 1px dashed #eee;
      padding-bottom: 5px;
      align-items: center;
    }
    button {
      padding: 12px;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: bold;
      margin: 5px;
      cursor: pointer;
      flex: 1;
      transition: transform 0.1s;
    }
    button:active { transform: scale(0.98); }
    .b-on { background: #27ae60; } 
    .b-off { background: #c0392b; } 
    .b-auto { background: #2980b9; } 
    .b-man { background: #f39c12; color: #333; }
    .b-dis { background: #e0e0e0 !important; color: #999 !important; pointer-events: none; }
    #error-box {
      display: none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(220,53,69,0.95);
      color: white;
      z-index: 99;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    input[type=number], input[type=time] {
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: center;
    }
    input[type=number] { width: 60px; }
    input[type=time] { width: 90px; }
    input[type=range] { width: 100%; margin-right: 10px; }
    .save-btn {
      background: #7f8c8d;
      font-size: 12px;
      padding: 5px 10px;
      flex: 0;
    }
    #mqtt-status { font-size: 12px; color: gray; }
  </style>
</head>

<body>
  <div id="error-box">
    <div style="font-size:20px;font-weight:bold;margin-bottom:20px;">
      ‚ö†Ô∏è C·∫¢NH B√ÅO!<br>B∆°m 3 l·∫ßn kh√¥ng ·∫©m!
    </div>
    <button onclick="mqttSendCmd('MAN')" style="background:white;color:red;width:200px;">
      T·∫ÆT B√ÅO ƒê·ªòNG
    </button>
  </div>

  <div class='card'>
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">V∆∞·ªùn Th√¥ng Minh MQTT</h3>
      <a href="history.html" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm">
        <i class="fa-solid fa-chart-line"></i> L·ªãch S·ª≠ T∆∞·ªõi
      </a>
    </div>

    <div id="mqtt-status">ƒêang k·∫øt n·ªëi MQTT...</div>
    <div id="auth-info" class="text-xs text-gray-500 mb-2">Auth...</div>

    <div class='row'><span>üïí Gi·ªù:</span><b id='time'>--</b></div>
    <div class='row'><span>üå°Ô∏è Nhi·ªát ƒë·ªô:</span><b id='temp'>-- ¬∞C</b></div>
    <div class='row'><span>üíß ƒê·ªô ·∫©m ƒë·∫•t:</span><b id='soil'>--</b></div>
    <div class='row'><span>‚öôÔ∏è Ch·∫ø ƒë·ªô:</span><b id='mode'>--</b></div>
    <div class='row'><span>üîå M√°y B∆°m:</span><b id='pump'>--</b></div>

    <div id='admin' style='margin-top:20px;'>
      <div style='display:flex;'>
        <button id='btnOn' class='b-on' onclick="mqttSendCmd('ON')">B·∫¨T</button>
        <button id='btnOff' class='b-off' onclick="mqttSendCmd('OFF')">T·∫ÆT</button>
      </div>
      <div style='display:flex;'>
        <button id='btnAu' class='b-auto' onclick="mqttSendCmd('AUTO')">AUTO</button>
        <button id='btnMan' class='b-man' onclick="mqttSendCmd('MAN')">TH·ª¶ C√îNG</button>
      </div>

      <hr style='border:0;border-top:1px solid #eee;margin:15px 0;'>

      <div class='row' style="display:block;text-align:left;">
        <div style="display:flex;justify-content:space-between;">
          <span>üöÄ T·ªëc ƒë·ªô b∆°m:</span><b id="lblSpd">255</b>
        </div>
        <div style="display:flex;align-items:center;margin-top:5px;">
          <input type="range" id="rngSpd" min="70" max="255" oninput="updSpd(this.value)" onchange="sndSpd(this.value)">
        </div>
      </div>

      <hr style='border:0;border-top:1px solid #eee;margin:15px 0;'>
      <div class='row'><span>ƒê·∫•t Kh√¥ B·∫≠t (>):</span>
        <div><input type='number' id='inS'><button class='save-btn' onclick="setVal('S', 'inS', 1, 1023)">L∆∞u</button></div>
      </div>
      <div class='row'><span>Nhi·ªát Max (<):</span>
        <div><input type='number' id='inT'><button class='save-btn' onclick="setVal('T', 'inT', 0, 100)">L∆∞u</button></div>
      </div>
      <div class='row' style="display:block;text-align:left">
        <div>Gi·ªù T∆∞·ªõi:</div>
        <div style="display:flex;justify-content:space-between;margin-top:5px;">
          <input type='time' step='1' id='inTS'> - <input type='time' step='1' id='inTE'>
          <button class='save-btn' onclick="setTime()">L∆∞u</button>
        </div>
      </div>

      <hr style='border:0;border-top:1px dashed #eee;margin:15px 0;'>
      <div class='row'><span>‚è±Ô∏è B∆°m (s):</span>
        <div><input type='number' id='inPon'><button class='save-btn' onclick="setVal('PON', 'inPon', 1, 300)">L∆∞u</button></div>
      </div>
      <div class='row'><span>‚è≥ Ngh·ªâ (s):</span>
        <div><input type='number' id='inSoak'><button class='save-btn' onclick="setVal('SOAK', 'inSoak', 1, 600)">L∆∞u</button></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // === C·∫§U H√åNH FIREBASE + MQTT ===
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db, auth, userId = null, isAuthReady = false;
    let lastPumpState = 0, pumpStartTimestamp = 0, lastStatusData = {};

    setLogLevel('debug');
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        document.getElementById('auth-info').innerText = `User ID: ${userId}`;
        isAuthReady = true;
      } else {
        userId = 'anonymous_' + crypto.randomUUID();
        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
        else await signInAnonymously(auth);
      }
    });

    // === MQTT ===
    const MQTT_SERVER = "broker.hivemq.com";
    const MQTT_PORT = 8884;
    const MQTT_CLIENT_ID = "Web_SmartGarden_" + parseInt(Math.random()*100000);
    const TOPIC_STATUS = "sg/esp32/garden1/status";
    const TOPIC_COMMAND = "sg/esp32/garden1/cmd";
    const TOPIC_SETTINGS = "sg/esp32/garden1/set";

    let mqttClient;

    function mqttConnect() {
      mqttClient = new Paho.MQTT.Client(MQTT_SERVER, MQTT_PORT, MQTT_CLIENT_ID);
      mqttClient.onConnectionLost = onConnectionLost;
      mqttClient.onMessageArrived = onMessageArrived;

      let options = {
        timeout: 3,
        onSuccess: onConnect,
        onFailure: onFailure,
        useSSL: true
      };
      document.getElementById('mqtt-status').innerText = "ƒêang k·∫øt n·ªëi...";
      mqttClient.connect(options);
    }

    function onConnect() {
      document.getElementById('mqtt-status').innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi MQTT";
      mqttClient.subscribe(TOPIC_STATUS);
      console.log("MQTT Connected & Subscribed to " + TOPIC_STATUS);
    }

    function onFailure(responseObject) {
      document.getElementById('mqtt-status').innerText = "‚ùå L·ªói k·∫øt n·ªëi MQTT. Th·ª≠ l·∫°i sau 5s.";
      console.log("MQTT Failed: " + responseObject.errorMessage);
      setTimeout(mqttConnect, 5000);
    }

    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("MQTT Connection Lost: " + responseObject.errorMessage);
        mqttConnect();
      }
    }

    function onMessageArrived(message) {
      if (message.destinationName === TOPIC_STATUS) {
        const data = JSON.parse(message.payloadString);
        logWateringEvent(data);
        updateUI(data);
        lastStatusData = data;
      }
    }

    window.mqttSendCmd = function(cmd) {
      if (mqttClient && mqttClient.isConnected()) {
        const message = new Paho.MQTT.Message(cmd);
        message.destinationName = TOPIC_COMMAND;
        mqttClient.send(message);
      } else alert("Ch∆∞a k·∫øt n·ªëi MQTT! Vui l√≤ng ch·ªù.");
    }

    window.mqttSendSetting = function(key, value) {
      if (mqttClient && mqttClient.isConnected()) {
        const message = new Paho.MQTT.Message(key + "=" + value);
        message.destinationName = TOPIC_SETTINGS;
        mqttClient.send(message);
      } else alert("Ch∆∞a k·∫øt n·ªëi MQTT! Vui l√≤ng ch·ªù.");
    }

    async function logWateringEvent(d) {
      if (d.p === 0 && lastPumpState === 1 && pumpStartTimestamp !== 0 && isAuthReady) {
        const durationSeconds = Math.round((Date.now() - pumpStartTimestamp)/1000);
        if (durationSeconds>0) {
          const historyData = {
            timestamp: new Date().toISOString(),
            userId: userId,
            durationSeconds: durationSeconds,
            triggerMode: lastStatusData.m === 1 ? 'AUTO' : 'MANUAL',
            soilReadingBefore: lastStatusData.s || null,
            soilReadingAfter: d.s,
            temperature: d.t,
            pumpSpeed: lastStatusData.sspd,
            appId: appId
          };
          try {
            const historyRef = collection(db, `artifacts/${appId}/public/data/watering_history`);
            await addDoc(historyRef, historyData);
            console.log("L·ªãch s·ª≠ t∆∞·ªõi ƒë√£ ƒë∆∞·ª£c ghi v√†o Firestore.");
          } catch(e) { console.error("L·ªói khi ghi l·ªãch s·ª≠ v√†o Firestore: ", e); }
        }
        pumpStartTimestamp = 0;
      } else if (d.p === 1 && lastPumpState === 0) {
        pumpStartTimestamp = Date.now();
        console.log("M√°y b∆°m B·∫¨T, ghi nh·∫≠n th·ªùi gian b·∫Øt ƒë·∫ßu.");
      }
      lastPumpState = d.p;
    }

    function updateUI(d){
      document.getElementById('time').innerText=d.time;
      document.getElementById('temp').innerText=d.t + ' ¬∞C';
      document.getElementById('soil').innerText=d.s;
      document.getElementById('mode').innerText=d.m?'AUTO':'TH·ª¶ C√îNG';

      const p=document.getElementById('pump');
      p.innerText=d.p?'CH·∫†Y ('+d.sspd+')':'T·∫ÆT'; 
      p.style.color=d.p?'#27ae60':'#c0392b';
      document.getElementById('error-box').style.display = (d.err==1)?'flex':'none';

      if(document.activeElement.tagName!='INPUT' && document.activeElement.tagName!='BUTTON'){
        document.getElementById('inS').value=d.ss;
        document.getElementById('inT').value=d.st;
        document.getElementById('inTS').value=d.sts.substring(0,5);
        document.getElementById('inTE').value=d.ste.substring(0,5);
        document.getElementById('inPon').value=d.spon;
        document.getElementById('inSoak').value=d.ssoak;
        document.getElementById('rngSpd').value=d.sspd;
        document.getElementById('lblSpd').innerText=d.sspd;
      }

      const bOn=document.getElementById('btnOn'),
            bOff=document.getElementById('btnOff'),
            bAu=document.getElementById('btnAu'),
            bMan=document.getElementById('btnMan');

      if(d.m==1){
        bOn.classList.add('b-dis'); bOff.classList.add('b-dis');
        bAu.style.border="2px solid #333"; bMan.style.border="none";
        bMan.style.opacity="0.5"; bAu.style.opacity="1";
      } else {
        bOn.classList.remove('b-dis'); bOff.classList.remove('b-dis');
        bMan.style.border="2px solid #333"; bAu.style.border="none";
        bAu.style.opacity="0.5"; bMan.style.opacity="1";
      }
    }

    window.updSpd=function(v){ document.getElementById('lblSpd').innerText=v; }
    window.sndSpd=function(v){ mqttSendSetting('SPD',v); }

    window.setVal=function(key,id,min,max){
      let val=parseInt(document.getElementById(id).value);
      if(isNaN(val) || val<min || val>max){ alert("Gi√° tr·ªã ko h·ª£p l·ªá!"); return; }
      mqttSendSetting(key,val); alert('ƒê√£ l∆∞u!');
    }

    window.setTime=function(){
      let t1=document.getElementById('inTS').value;
      let t2=document.getElementById('inTE').value;
      if(t1.length==5) t1+=":00"; 
      if(t2.length==5) t2+=":00";
      mqttSendSetting('TS', t1); 
      mqttSendSetting('TE', t2); 
      alert('ƒê√£ l∆∞u gi·ªù!');
    }

    window.onload = mqttConnect;
  </script>
</body>
</html>
