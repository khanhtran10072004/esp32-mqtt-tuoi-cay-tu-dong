<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>B√°o C√°o L·ªãch S·ª≠ T∆∞·ªõi Ti√™u</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f7f6;
      color: #333;
      padding: 10px;
    }
    .card {
      background: #fff;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
  </style>
</head>

<body>
  <div class='card'>
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">üìä B√°o C√°o L·ªãch S·ª≠ T∆∞·ªõi Ti√™u</h2>

      <a
        href="index.html"
        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm">
        Quay l·∫°i Dashboard
      </a>
    </div>

    <p id="loading-status" class="text-center text-indigo-500 font-medium">
      ƒêang t·∫£i l·ªãch s·ª≠ t·ª´ Firebase...
    </p>

    <div id="history-container" class="mt-4">
      <!-- D·ªØ li·ªáu l·ªãch s·ª≠ s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
    </div>
  </div>


  <!-- FIREBASE SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


    // ==== C·∫§U H√åNH FIREBASE ====
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;


    // ==== KH·ªûI T·∫†O FIREBASE ====
    setLogLevel('debug');

    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);


    // ==== X√ÅC TH·ª∞C FIREBASE ====
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        isAuthReady = true;
        fetchHistory();
      } else {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
        } catch (e) {
          console.error("L·ªói x√°c th·ª±c Firebase:", e);
        }
      }
    });



    // ==== H√ÄM T·∫¢I D·ªÆ LI·ªÜU L·ªäCH S·ª¨ ====
    function fetchHistory() {
      if (!isAuthReady || !db) return;

      const container = document.getElementById('history-container');
      const status = document.getElementById('loading-status');

      try {
        const historyCollectionRef = collection(
          db,
          `artifacts/${appId}/public/data/watering_history`
        );

        // Firestore kh√¥ng d√πng orderBy v√¨ thi·∫øu index ‚Üí s·∫Øp x·∫øp b·∫±ng JS
        const q = query(historyCollectionRef);

        onSnapshot(
          q,
          (snapshot) => {
            let historyItems = [];

            snapshot.forEach(doc => {
              historyItems.push({ id: doc.id, ...doc.data() });
            });

            // S·∫Øp x·∫øp theo timestamp m·ªõi nh·∫•t
            historyItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            renderHistory(historyItems);
            status.classList.add('hidden');
          },

          (error) => {
            console.error("L·ªói Real-time Listener:", error);
            status.innerText = "‚ùå L·ªói t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠.";
            status.classList.remove('hidden');
          }
        );

      } catch (e) {
        console.error("L·ªói truy v·∫•n Firestore:", e);
        document.getElementById('loading-status').innerText = "‚ùå L·ªói h·ªá th·ªëng khi truy v·∫•n d·ªØ li·ªáu.";
      }
    }



    // ==== H√ÄM HI·ªÇN TH·ªä D·ªÆ LI·ªÜU ====
    function renderHistory(items) {
      const container = document.getElementById('history-container');

      if (items.length === 0) {
        container.innerHTML = `
          <p class="text-center text-gray-500 py-10">
            Ch∆∞a c√≥ d·ªØ li·ªáu t∆∞·ªõi n√†o ƒë∆∞·ª£c ghi l·∫°i.
          </p>`;
        return;
      }


      let html = `
        <div class="overflow-x-auto rounded-lg shadow-md">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
              <tr class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                <th class="px-4 py-3">Th·ªùi Gian</th>
                <th class="px-4 py-3">Ch·∫ø ƒê·ªô</th>
                <th class="px-4 py-3 text-center">‚è±Ô∏è B∆°m (gi√¢y)</th>
                <th class="px-4 py-3 text-center">üíß ƒê·ªô ·∫®m Tr∆∞·ªõc / Sau</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
      `;


      items.forEach(item => {
        const date = new Date(item.timestamp);

        const formattedTime =
          date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) +
          '<br>' +
          date.toLocaleDateString('vi-VN');

        const modeClass = item.triggerMode === 'AUTO'
          ? 'text-blue-600'
          : 'text-yellow-600';

        html += `
          <tr class="hover:bg-gray-50 transition duration-100">
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 leading-snug">${formattedTime}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${modeClass}">${item.triggerMode}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-green-600 font-bold">${item.durationSeconds}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-700">${item.soilReadingBefore} ‚Üí ${item.soilReadingAfter}</td>
          </tr>
        `;
      });


      html += `</tbody></table></div>`;
      container.innerHTML = html;
    }
  </script>

</body>
</html>
